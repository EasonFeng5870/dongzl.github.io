<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">

    

    

    <title>10-MySQL-InnoDB-Transaction | 善积跬步 方以千里</title>
    <meta name="author" content="dongzl">
    <meta name="version" content="1.0.0">
    <meta name="keywords" content>
    <meta name="description" content="背景描述目前在维护的 APP 进行了整体重构（其实不能算重构，应该是重新开发），新的服务端系统根据业务场景进行了功能拆分，实现了微服务，结束了以前服务端大一统的部署模式；伴随着微服务的上线，分布式事务也成了一个绕不开的问题。最近的几篇文章计划结合目前项目中的分布式事务的代码实现逻辑，对数据库事务的知识进行系统的学习和整理，当然数据库事务方面的知识很多，所以肯定不是一篇文章可以搞定的，分布式 就是要 “分布试”。PS.数据库事务的知识有哪些，一起来整理一下，今天先以 MySQL 数据库 I...">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">

    
    <link rel="alternate" href="/atom.xml" title="善积跬步 方以千里" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <main class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">善积跬步 方以千里</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/">
                <span class="nav-text">首页</span>
            </a>
        
            <a class="nav-item" href="/categories/java">
                <span class="nav-text">Java</span>
            </a>
        
            <a class="nav-item" href="/categories/web">
                <span class="nav-text">web</span>
            </a>
        
            <a class="nav-item" href="/categories/database">
                <span class="nav-text">数据库</span>
            </a>
        
            <a class="nav-item" href="/categories/data-structures-algorithms">
                <span class="nav-text">算法</span>
            </a>
        
            <a class="nav-item" href="/categories/architectural-design">
                <span class="nav-text">架构</span>
            </a>
        
            <a class="nav-item" href="/categories/design-pattern">
                <span class="nav-text">设计模式</span>
            </a>
        
            <a class="nav-item" href="/categories/other">
                <span class="nav-text">其他</span>
            </a>
        
            <a class="nav-item" href="/categories">
                <span class="nav-text">分类</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">标签</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">归档</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">关于</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="https://dongzl.github.io"></form>

        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#背景描述"><span class="toc-number">1.</span> <span class="toc-text">背景描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事务的ACID特性"><span class="toc-number">2.</span> <span class="toc-text">事务的ACID特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#A：原子性（Atomicity）"><span class="toc-number">2.1.</span> <span class="toc-text">A：原子性（Atomicity）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C：一致性（Consistency）"><span class="toc-number">2.2.</span> <span class="toc-text">C：一致性（Consistency）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#I：隔离性（Isolation）"><span class="toc-number">2.3.</span> <span class="toc-text">I：隔离性（Isolation）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#D：持久性（Durability）"><span class="toc-number">2.4.</span> <span class="toc-text">D：持久性（Durability）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事务的并发一致性问题"><span class="toc-number">3.</span> <span class="toc-text">事务的并发一致性问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#丢失更新"><span class="toc-number">3.1.</span> <span class="toc-text">丢失更新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#第一类丢失更新"><span class="toc-number">3.1.1.</span> <span class="toc-text">第一类丢失更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第二类丢失更新"><span class="toc-number">3.1.2.</span> <span class="toc-text">第二类丢失更新</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#脏读"><span class="toc-number">3.2.</span> <span class="toc-text">脏读</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#不可重复读"><span class="toc-number">3.3.</span> <span class="toc-text">不可重复读</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#幻读（幻影读）"><span class="toc-number">3.4.</span> <span class="toc-text">幻读（幻影读）</span></a></li></ol></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content"><article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            10-MySQL-InnoDB-Transaction
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://dongzl.github.io/2019/11/19/10-MySQL-InnoDB-Transaction/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-11-19T11:08:31.000Z" itemprop="datePublished">2019-11-19</time>
</a>

            

        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="背景描述"><a href="#背景描述" class="headerlink" title="背景描述"></a>背景描述</h2><p>目前在维护的 APP 进行了整体重构（其实不能算重构，应该是重新开发），新的服务端系统根据业务场景进行了功能拆分，实现了微服务，结束了以前服务端大一统的部署模式；伴随着微服务的上线，分布式事务也成了一个绕不开的问题。最近的几篇文章计划结合目前项目中的分布式事务的代码实现逻辑，对数据库事务的知识进行系统的学习和整理，当然数据库事务方面的知识很多，所以肯定不是一篇文章可以搞定的，<strong>分布式</strong> 就是要 <strong>“分布试”</strong>。</p>
<p><strong>PS.数据库事务的知识有哪些，一起来整理一下，今天先以 MySQL 数据库 InnoDB 存储引擎为例，总结一下单数据库事务。</strong></p>
<h2 id="事务的ACID特性"><a href="#事务的ACID特性" class="headerlink" title="事务的ACID特性"></a>事务的ACID特性</h2><h3 id="A：原子性（Atomicity）"><a href="#A：原子性（Atomicity）" class="headerlink" title="A：原子性（Atomicity）"></a>A：原子性（Atomicity）</h3><p>事务被视为不可分割的最小单元，事务的所有操作要么全部提交成功，要么全部失败回滚。</p>
<h3 id="C：一致性（Consistency）"><a href="#C：一致性（Consistency）" class="headerlink" title="C：一致性（Consistency）"></a>C：一致性（Consistency）</h3><p>一致性指事务将数据库从一种状态转变为下一种一致的状态。在事务开始之前和事务结束之后，数据库的完整性约束没有被破坏。在一致性状态下，所有事务对一个数据的读取结果都是相同的。</p>
<h3 id="I：隔离性（Isolation）"><a href="#I：隔离性（Isolation）" class="headerlink" title="I：隔离性（Isolation）"></a>I：隔离性（Isolation）</h3><p>一个事务所做的修改在最终提交以前，对其它事务是不可见的。</p>
<h3 id="D：持久性（Durability）"><a href="#D：持久性（Durability）" class="headerlink" title="D：持久性（Durability）"></a>D：持久性（Durability）</h3><p>一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务的执行结果页不能丢失。</p>
<h2 id="事务的并发一致性问题"><a href="#事务的并发一致性问题" class="headerlink" title="事务的并发一致性问题"></a>事务的并发一致性问题</h2><h3 id="丢失更新"><a href="#丢失更新" class="headerlink" title="丢失更新"></a>丢失更新</h3><h4 id="第一类丢失更新"><a href="#第一类丢失更新" class="headerlink" title="第一类丢失更新"></a>第一类丢失更新</h4><p>一个事务（A）更新某条记录数据，此时还未提交，这时另外一个事务（B）也更新了该记录数据并提交事务成功，这时 A 撤销事务，此时 B 更新成功的数据会丢失。</p>
<table>
<thead>
<tr>
<th>时间</th>
<th>事务A</th>
<th>事务B</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1</td>
<td>开启事务</td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td></td>
<td>开启事务</td>
</tr>
<tr>
<td>T3</td>
<td>查询账户余额为 100</td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td>查询账户余额为 100</td>
</tr>
<tr>
<td>T5</td>
<td></td>
<td>更新数据 + 10 结果为 110</td>
</tr>
<tr>
<td>T6</td>
<td></td>
<td>提交事务</td>
</tr>
<tr>
<td>T7</td>
<td>更新数据 - 10 结果为 90</td>
<td></td>
</tr>
<tr>
<td>T8</td>
<td>撤销事务</td>
<td></td>
</tr>
<tr>
<td>T7</td>
<td>数据恢复为100（丢失更新）</td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="第二类丢失更新"><a href="#第二类丢失更新" class="headerlink" title="第二类丢失更新"></a>第二类丢失更新</h4><p>一个事务（A）更新某条记录数据，此时还未提交，这时另外一个事务（B）也更新了该记录数据并提交事务成功，此时 A 提交事务，此时 B 更新成功的数据会丢失。</p>
<table>
<thead>
<tr>
<th>时间</th>
<th>事务A</th>
<th>事务B</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1</td>
<td>开启事务</td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td></td>
<td>开启事务</td>
</tr>
<tr>
<td>T3</td>
<td>查询账户余额为100</td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td>查询账户余额为100</td>
</tr>
<tr>
<td>T5</td>
<td></td>
<td>更新数据 - 10 结果为 90</td>
</tr>
<tr>
<td>T6</td>
<td></td>
<td>提交事务</td>
</tr>
<tr>
<td>T7</td>
<td>更新数据 + 10 结果 为 110</td>
<td></td>
</tr>
<tr>
<td>T8</td>
<td>提交事务</td>
<td></td>
</tr>
<tr>
<td>T7</td>
<td>数据结果为110（丢失更新）</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="脏读"><a href="#脏读" class="headerlink" title="脏读"></a>脏读</h3><p>脏读是指一个事务读取到了另外一个事务未提交的数据。一个事务正在对一条记录进行修改，在这个事务提交并完成前，这条记录的数据就处于不一致状态。这时， 另一个事务也来读取同一条记录，如果不加控制，第二个事务读取了这些“脏”数据，并据此做进一步的处理，就会产生未提交的数据依赖关系。</p>
<table>
<thead>
<tr>
<th>时间</th>
<th>事务A</th>
<th>事务B</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1</td>
<td>开启事务</td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td>查询账户余额为100</td>
<td>开启事务</td>
</tr>
<tr>
<td>T3</td>
<td>充值50，余额修改为150</td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td>查询余额为150</td>
</tr>
<tr>
<td>T5</td>
<td>撤销事务，余额改回100</td>
<td></td>
</tr>
<tr>
<td>T6</td>
<td></td>
<td>汇入50，余额修改为200</td>
</tr>
<tr>
<td>T7</td>
<td></td>
<td>提交事务</td>
</tr>
</tbody>
</table>
<h3 id="不可重复读"><a href="#不可重复读" class="headerlink" title="不可重复读"></a>不可重复读</h3><p>不可重复读是指一个事务读取到了另外一个事务已提交的数据。一个事务（A）读取某一个数据后，另外一个事务（B）对该数据进行了修改，当 A 再读取这个数据时，发现前后两次读取的数据不一致。</p>
<table>
<thead>
<tr>
<th>时间</th>
<th>事务A</th>
<th>事务B</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1</td>
<td>开启事务</td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td>查询账户余额为100</td>
<td>开启事务</td>
</tr>
<tr>
<td>T3</td>
<td></td>
<td>更新账户余额为150 </td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td>提交事务</td>
</tr>
<tr>
<td>T5</td>
<td>查询账户余额为150</td>
<td></td>
</tr>
<tr>
<td>T6</td>
<td>…</td>
<td></td>
</tr>
<tr>
<td>T7</td>
<td>提交事务</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="幻读（幻影读）"><a href="#幻读（幻影读）" class="headerlink" title="幻读（幻影读）"></a>幻读（幻影读）</h3><p>一个事务（A）按某一条件检索到 N 条数据，另外一个事务（B）新增或删除了满足条件的数据，这时 A 再按相同条件检索数据，查询到的结果 != N。</p>
<table>
<thead>
<tr>
<th>时间</th>
<th>事务A</th>
<th>事务B</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1</td>
<td>开启事务</td>
<td>开启事务</td>
</tr>
<tr>
<td>T2</td>
<td>select * from table where condition = ‘xxx’ 返回 N 条记录</td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td></td>
<td>向 table 表插入一条满足 condition = ‘xxx’ 的数据</td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td>提交事务</td>
</tr>
<tr>
<td>T5</td>
<td>select * from table where condition = ‘xxx’ 返回 N + 1 条记录</td>
<td></td>
</tr>
<tr>
<td>T6</td>
<td>…</td>
<td></td>
</tr>
<tr>
<td>T7</td>
<td>提交事务</td>
<td></td>
</tr>
</tbody>
</table>
<div id="flowchart-0" class="flow-chart"></div>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">    A--&gt;B;</span><br><span class="line">    A--&gt;C;</span><br><span class="line">    B--&gt;D;</span><br><span class="line">    C--&gt;D;</span><br></pre></td></tr></table></figure>
<img src="http://www.plantuml.com/plantuml/svg/SyfFqhLppCbCJbMmKiX8pSd91m00">
<p><script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script><textarea id="flowchart-0-code" style="display: none">st=>start: Start|past:>http://www.google.com[blank]
e=>end: End:>http://www.google.com
op1=>operation: My Operation|past
op2=>operation: Stuff|current
sub1=>subroutine: My Subroutine|invalid
cond=>condition: Yes
or No?|approved:>http://www.google.com
c2=>condition: Good idea|rejected
io=>inputoutput: catch something...|request

st->op1(right)->cond
cond(yes, right)->c2
cond(no)->sub1(left)->op1
c2(yes)->io->e
c2(no)->op2->e</textarea><textarea id="flowchart-0-options" style="display: none">{"scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script></p>

        
    </section>
</article>



<div class="comments">
    <div id="comments"></div>
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
    new Gitalk({
        clientID: "791785cb3bf7b9b5f1ea",
        clientSecret: "a73d2380b7dba08575e0190989ef017e480c20c9",
        repo: "dongzl.github.io",
        owner: "dongzl",
        admin: ["dongzl"],
        id: "2019/11/19/10-MySQL-InnoDB-Transaction",
        distractionFreeMode: true,
        title: "10-MySQL-InnoDB-Transaction",
        body: "https://dongzl.github.io/2019/11/19/10-MySQL-InnoDB-Transaction/",
        labels: []
    }).render('comments');
    </script>
</div>

</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?e4027971a230b210f4671f485b33846a";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    
</footer>

    </main>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }
            
            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle();
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp();
            }, 3000);
        }
    });
    </script>
    
        <script type="text/javascript" src="/js/scrollspy.min.js"></script>
        <script type="text/javascript">
        $(document.body).scrollspy({target: '#aside-inner'});
        </script>
    

</body>
</html>
